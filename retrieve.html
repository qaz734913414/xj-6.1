<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="js/city/distpicker.data.js"></script>
    <script src="js/city/distpicker.js"></script>

</head>
<body>


<div class="container-fluid ">


    <div class="row vertical-center">
        <div class="col-sm-4 col-sm-offset-4 col-md-3 col-md-offset-4 col-lg-2 col-lg-offset-5 add-img-box"
             style="margin-top: 228px;">

            <div href="#" class="thumbnail add-img"><img src="./img/default_img.png" class=""
                                                         style="height: 270px;"></div>
            <textarea id="remark" class="form-control hidden" rows="2" placeholder="请输入检索事由"></textarea>
            <button id="add-image-button" class="btn  btn-lg btn-block face-button"
                    style="position: relative; overflow: hidden; direction: ltr;">
                <span class="fa fa-plus"></span>&nbsp;<span id="add-image-button-span">添加照片</span>
                <input qq-button-id="07a6d03a-459a-4aaa-be8f-8bae1f562e99" type="file" name="qqfile"
                       style="position: absolute; right: 0px; top: 0px; font-family: Arial; font-size: 118px; margin: 0px; padding: 0px; cursor: pointer; opacity: 0;">
            </button>
            <div class="row select-button hidden">
                <div class="col-sm-6 col-md-6 col-lg-6">
                    <select class=" form-control ">
                        <option value="0" selected="">云创</option>
                        <option value="1">依图</option>
                        <option value="2">旷视</option>
                    </select>
                </div>
                <div class="col-sm-6 col-md-6 col-lg-6">
                    <button id="upload-button" class="btn btn-large  btn-block face-button">
                        <span class="fa fa-search" aria-hidden="true"></span>&nbsp;开始检索
                    </button>
                </div>
            </div>

        </div>
        <div class="col-sm-4 col-md-3 col-lg-2">

        </div>
        <div class="col-sm-8 col-md-9 col-lg-10">
            <div class="row filter-box hidden ">
                <form class="form-inline face-form">
                    <div class="form-group">
                        <div data-toggle="distpicker" id="distpicker">
                            <select class="form-control" data-province="新疆维吾尔自治区"></select>
                            <select class="form-control" data-city="乌鲁木齐"></select>
                            <select class="form-control" data-district="天山区"></select>
                        </div>
                    </div>
                    <div class="form-group">
                        <select class="form-control">
                            <option>民族</option>
                            <option>汉族</option>
                            <option>维吾尔族</option>
                            <option>满族</option>
                            <option>蒙古族</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <select class="form-control">
                            <option>性别</option>
                            <option>男</option>
                            <option>女</option>

                        </select>
                    </div>
                    <div class="form-group">
                        <select class="form-control">
                            <option>重点人员</option>
                            <option>是</option>
                            <option>否</option>
                            <option>未知</option>
                        </select>
                    </div>
                    <div class="form-group mydate">
                        <label class=" ">出生日期</label> <input type="text" class="form-control" name="from"> — <input
                            type="text" class="form-control" name="to">
                    </div>

                    <div class="form-group">
                        <button class="btn face-button">筛选</button>
                    </div>
                </form>
            </div>

            <div class="row result-box ">


                <div class="container-fluid">
                    <div class="row">

                        </div>
                </div>
            </div>
        </div>

    </div>


</div>

<!-- 提示框开始 -->
<div class="modal fade" id="retrieveModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><span class="fa fa-times"
                                                                                                  aria-hidden="true"></span>
                </button>
                <h4 class="modal-title">对比详情</h4>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-sm-4 col-md-4 col-lg-4 text-center show-resource">
                        <h4>检索图片</h4>
                        <div class="thumbnail">
                            <img src="./img/default_img.png" alt="..." style="height: 294px;">
                        </div>
                    </div>
                    <div class="col-sm-1 col-md-1 col-lg-1 text-center similar">
                        <div class="similar-box" style="height: 74px;">
                            <p><span>相似度</span></p>
                            <p><span><font>99.</font><font>55%</font></span></p>
                        </div>

                    </div>
                    <div class="col-sm-4 col-md-4 col-lg-4 text-center show-results">


                        <button type="button" class="btn left-btn"><span class="fa  fa-chevron-left"></span></button>
                        <h4>检索结果</h4>
                        <button type="button" class="btn right-btn"><span class="fa  fa-chevron-right"
                                                                          aria-hidden="true"></span></button>

                        <div class="thumbnail">
                            <img id="modal-img" src="./img/default_img.png" alt="..."
                                 style="height: 294px;">
                        </div>
                    </div>
                    <div class="col-sm-3 col-md-3 col-lg-3 items">
                        <h4 class="text-center">结果详情</h4>
                        <h4> &nbsp;</h4>
                        <div class="caption">
                                <!-- <p>相似度：<font id="similar">99.07%</font></p>
                                <p>姓名：买买提.哈密尔.塔依尔坤.刀塔基德</p>
                                <p>地区：<font id="area"></font></p>
                                <p>出生年月：1987.5.5</p> -->
                            </div>
                    </div>
                </div>
                <div class="row ">
                    <div class="col-sm-9 col-md-9 col-lg-9 text-center">
                        <p class="hint">小提示：点击相似度按钮可以选择比中</p>
                    </div>
                </div>
            </div>

        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal -->
</div>
<!-- 提示框结束 -->
<div class="modal fade face-modal " id="retrieveModal2" tabindex="1" role="dialog" aria-labelledby="myModalLabel"
     data-backdrop="static" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><span class="fa fa-times"
                                                                                                  aria-hidden="true"></span>
                </button>
                <h4 class="modal-title">比中详情</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal">
                    <div class="form-group">
                        <label class="col-sm-4 control-label">手机号</label>
                        <div class="col-sm-6">
                            <input type="text" class="form-control" id="phoneNo" placeholder="请填写手机号">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-4 control-label">车牌号</label>
                        <div class="col-sm-6">
                            <input type="text" class="form-control" id="carNo" placeholder="请填写车牌号">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-4 control-label">有害标志</label>
                        <div class="col-sm-6" id="harmful">
                            <label class="radio-inline">
                                <input type="radio" name="harmful" id="inlineRadio1" value="1"> 有害
                            </label>
                            <label class="radio-inline">
                                <input type="radio" name="harmful" id="inlineRadio2" value="2"> 无害
                            </label>
                            <label class="radio-inline">
                                <input type="radio" name="harmful" id="inlineRadio3" value="3"> 未知
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-4 control-label">处理方式</label>
                        <div class="col-sm-6">
                            <select class="form-control" id="dispose">
                                <option value="0" selected="selected">未处理</option>
                                <option value="1">警告</option>
                                <option value="2">拘留</option>
                                <option value="3">行政处罚</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-4 control-label">备注</label>
                        <div class="col-sm-6">
                            <textarea class="form-control" id="modal-remark" rows="2" placeholder="请填写备注"></textarea>
                        </div>
                    </div>

                </form>
            </div>
            <div class="modal-footer">
                <button type="button" data-dismiss="modal" class="btn btn-default">取消</button>
                <button type="button" id="chosen-button" class="btn face-button">提交比中详情</button>
            </div>
        </div>
        <!-- /.modal-content -->

    </div>
    <!-- /.modal -->
    <!-- 提示框结束 -->



    <script id="imgTemp" type="text/html">
        <div class="col-sm-4 col-md-3 col-lg-2">
            <div class="thumbnail {{= focus==''?'':' focus'}}">
                <img src={{= url}} alt="...">
                <div class="caption">
                    <p><span>相似度：</span><span class="similar"><font>{{= percent.toString().substring(0,3)}}</font><font>{{= percent.toString().substring(3,5)+"%"}}</font></span>
                    </p>
                    <p>姓名：{{= name}}</p>
                    <p class="hidden">性别：{{= sex==0?'男':'女'}}</p>
                    <p class="hidden">民族：</p>
                    <p>地区：</p>
                    <p class="hidden">身份证号：{{= idNo}}</p>
                    <p>出生年月： {{= birthday}}</p>
                    {{if focus}}
                    <p class="hidden focus-font">重点人员情况：{{= focus}}'</p>
                    {{/if}}
                </div>
            </div>
        </div>
    </script>


</div>
</body>
<script type="text/javascript">
    var $distpicker = $('#distpicker');

    $('#reset').click(function () {
        $distpicker.distpicker('reset');
    });

    $('#reset-deep').click(function () {
        $distpicker.distpicker('reset', true);
    });

    $('#destroy').click(function () {
        $distpicker.distpicker('destroy');
    });
    var uploadFile;
    var heightFactor = 1.2;//图片高度宽度比例
    var logId;//全局调用

    $(function () {
        logId = null;
        var uploader = bindUploadFileComponent("add-image-button");
        $("#upload-button").bind("click", upload);
        $("#retrieveModal .similar-box").bind("click", function () {
            $("#retrieveModal2").modal();
            $("#retrieveModal2 .modal-body #phoneNo").val("");
            $("#retrieveModal2 .modal-body #carNo").val("");
            $("#retrieveModal2 .modal-body #modal-remark").val("");
        });
        $("input[name=from],input[name=to]").datetimepicker({
            format: 'yyyy-mm-dd',
            language: 'zh-CN',
            minView: 2,
            autoclose: true,
            inputMask: true
        });

        $("#chosen-button").bind("click", function () {
            uploadChosen();


        });

        winChange();

        $(window).resize(function () {
            winChange();
        });


    });
    //图片和文字宽高位置调整，初始化和窗口位置改变时调用
    function winChange() {


        //统一图片高度，防止不对齐
        var width = $(".result-box .thumbnail img").width();
        $(".result-box .thumbnail img").height(width * heightFactor);
        //图片对齐
        width = $("#retrieveModal .modal-body .thumbnail img").width();
        $("#retrieveModal .modal-body .thumbnail img").height(width * heightFactor);
        //按钮置园
        width = $("#retrieveModal .modal-body .similar-box").width();
        $("#retrieveModal .modal-body .similar-box").height(width);
        //按钮文字居中
        console.info($("#retrieveModal .modal-body .similar-box").height() + "   " + $("#retrieveModal .modal-body .similar-box > p:first-child").height() + "   "
            + $("#retrieveModal .modal-body .similar-box > p:last-child").height()
        );

        width = $(".add-img-box .thumbnail img").width();
        $(".add-img-box .thumbnail img").height(width * heightFactor);
        //图片框垂直居中

    }

    function showImageOnModal(resource) {
        $("#modal-img").attr("src", resource.find("img").attr("src"));
        $("#retrieveModal .similar-box p:last-child span").html(resource.find(".caption>p:first-child>span:last-child").html());
        $("#retrieveModal .caption").html(resource.find(".caption").html());
        $("#retrieveModal .caption .hidden").removeClass("hidden");
        $("#retrieveModal .caption p:first-child").addClass("hidden");
        //重点人员
        if (resource.hasClass("focus")) {
            $("#retrieveModal .show-results .thumbnail").addClass("focus");
        } else {
            $("#retrieveModal .show-results .thumbnail").removeClass("focus");
        }

    }


    function upload() {
        if (uploadFile == null) {
            alert("请选择图片");
            return;
        }
        var form_Data = new FormData();
        form_Data.append("file", uploadFile);
        form_Data.append("type", $(".add-img-box select").val());
        form_Data.append("remark", $("#remark").val());
        //防止同时多次提交
        var uploadButton = $(this);
        uploadButton.addClass("disabled");
        $.ajax({
            type: 'post',
            url: pathurl + '/face/retrieve/',
            data: form_Data,
            cache: false,
            contentType: false,
            processData: false,
            dataType: 'json',
            success: function (data) {
                console.info(data);
                if (data.code == 200) {
                    logId = data.logId;
                    //alert("拿到了logId："+logId);
                    $("#add-image-button-span").text("重新添加照片");
                    $("#add-image-button").removeClass("hidden");
                    $(".select-button").addClass("hidden");
                    $(".add-img-box")
                        .removeClass(
                            "col-sm-4 col-sm-offset-4 col-md-3 col-md-offset-4 col-lg-2 col-lg-offset-5");
                    $(".add-img-box").addClass(
                        "col-sm-4 col-md-3 col-lg-2 mybackground ");

                    $(".vertical-center").removeClass("vertical-center");
                    $(".add-img-box").css("margin-top", "0px");
                    $(".filter-box").removeClass("hidden");
                    //展示图片
                    $(".result-box .container-fluid .row").html("");//清空

                    var imgs = data.result;
                    var imgsDom = $(".result-box .container-fluid .row");
                    //排序
                    imgs.sort(function (a, b) {
                        return b.percent - a.percent;
                    });
                    $('#imgTemp').tmpl(imgs).appendTo(imgsDom);


                    winChange();//调整高宽
                    //绑定图片点击事件
                    $(".result-box .thumbnail").bind('click', function () {
                        $("#retrieveModal").modal();
                        //赋值
                        showImageOnModal($(this));
                        //设置当前图片dom的索引，以便左右翻图
                        var imageDom = $(this);
                        //绑定左右切换事件
                        $("#retrieveModal .right-btn").bind("click", function () {
                            if (!imageDom.parent().next().find(".thumbnail img").attr("src")) {
                                return;
                            }
                            imageDom = imageDom.parent().next().find(".thumbnail");
                            showImageOnModal(imageDom);
                        });

                        $("#retrieveModal .left-btn").bind("click", function () {
                            if (!imageDom.parent().prev().find(".thumbnail img").attr("src")) {
                                return;
                            }
                            imageDom = imageDom.parent().prev().find(".thumbnail");
                            console.info(imageDom);
                            showImageOnModal(imageDom);
                        });
                        //绑定按钮事件
                        $("#retrieveModal .similar-box").bind("mouseover", function () {
                            $("#retrieveModal .similar-box > p:last-child").hide();
                            $("#retrieveModal .similar-box > p:first-child span").text("比 中");
                            $("#retrieveModal .similar-box").addClass("selected");


                        });

                        $("#retrieveModal .similar-box").bind("mouseout", function () {
                            $("#retrieveModal .similar-box > p:last-child").show();
                            $("#retrieveModal .similar-box > p:first-child span").text("相似度");
                            $("#retrieveModal .similar-box").removeClass("selected");


                        });
                        winChange();
                    });


                } else {
                    $("#modal-body-id").text("操作失败，请重试");
                    $("#myModal").modal();

                }

                uploadButton.removeClass("disabled");

            },
            error: function () {
                uploadButton.removeClass("disabled");
                console.error("ajax upload error");

            }
        });
    }


    function uploadChosen() {
        var dataObj = new Object();
        dataObj.logId = logId;
        dataObj.phoneNo = $("#retrieveModal2 .modal-body #phoneNo").val();
        dataObj.carNo = $("#retrieveModal2 #carNo").val();
        dataObj.remark = $("#retrieveModal2 #modal-remark").val();
        dataObj.dispose = $("#retrieveModal2 #dispose").val();
        dataObj.harmful = $("#retrieveModal2 input[name='harmful']:checked").val();
        dataObj.url = $("#retrieveModal .show-results .thumbnail img").attr("src");
        var name = $("#retrieveModal .caption > p:nth-child(2)").text();
        var idNo = $("#retrieveModal .caption > p:nth-child(6)").text();
        dataObj.name = name.substring(name.indexOf("：") + 1);
        dataObj.idNo = idNo.substring(idNo.indexOf("：") + 1);
        console.info(idNo);
        $.ajax({
            type: 'post',
            url: pathurl + 'facelog/insertChosenInfo/',
            data: JSON.stringify(dataObj),
            cache: false,
            contentType: false,
            processData: false,
            dataType: 'json',
            success: function (data) {
                if (data.msg == "SUCCESS") {
                    $("#modal-body-id").text("比中成功");
                    $("#myModal").modal();
                    $("#retrieveModal2").modal("hide");
                } else {
                    $("#modal-body-id").text("操作失败，请重试");
                    $("#myModal").modal();
                }
            },
            error: function () {
                console.error("ajax upload error");

            }
        });

    }

    function bindUploadFileComponent(buttonid) {
        return new qq.FineUploaderBasic({
            button: $("#" + buttonid)[0],
            request: {
                endpoint: pathurl + 'face/retrieve',
                method: "POST"
            },
            validation: {
                allowedExtensions: ['jpeg', 'jpg', 'gif', 'png'],
            },
            debug: true,
            multiple: false,
            autoUpload: false,
            editFilename: {
                enable: false
            },
            messages: {
                noFilesError: '没有选中文件'
            },
            text: {
                formatProgress: "{percent}% of {total_size}",
                failUpload: "上传失败",
                waitingForResponse: "上传中...",
                paused: "暂停"
            },
            callbacks: {
                onError: function (id, filename, message, xhr) {
                    console.log("id" + filename, '上传失败');
                    if (filename == undefined)
                        alert("请选择图片或重新选择图片");
                },
                onSubmit: function (id, filename) {
                    console.log(filename, '文件开始提交');
                    var self = this;

                    $("#add-image-button").addClass("hidden");
                    $("#remark").removeClass("hidden");
                    $(".select-button").removeClass("hidden");
                    //画框展示
                    this.drawThumbnail(id, $(".add-img-box .add-img img")[0]);
                    //子页面展示
                    this.drawThumbnail(id, $("#retrieveModal .modal-body .thumbnail img")[0]);
                    //由于上传完成后文件会自动清空，需要保存到uploadFiles
                    uploadFile = self.getFile(id);

                },
                onComplete: function (id, filename, responseJSON, xhr) {
                    console.log(filename, '上传成功，返回信息为：', responseJSON);
                    //object可以如下初始化表格
                    /*
                     if (imagetable)
                     imagetable.fnDestroy(false);
                     imageTable(responseJSON.imgs); */
                    var self = this;
                    //  self.clearStoredFiles();
                }
            }
        });

    }
</script>

</html>